<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>捨てたブツの記録</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="/style.css">
	<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js'></script>
    <style>
        /* デスクトップではサイドバーを非表示にしない */
        @media (min-width: 992px) {
            .offcanvas-lg {
                visibility: visible !important;
                position: relative !important;
                border: none !important;
                transform: none !important;
                width: auto !important;
            }
        }
		.custom-day-link {
		    display: block;
		    padding: 4px;
		    text-decoration: none;
		    color: #333;
		}
		.content-wrapper {
	  		min-height: 85vh;
			flex-grow: 1;
			padding: 1rem;
			overflow-y: auto;
		}
		    
	</style>
</head>
<body>

	<div th:replace="~{discard/fragments/header :: header}"></div>

    <div class="container-fluid">
        <div class="row">
            
            <nav class="col-lg-3 bg-light p-3 pt-5 pb-4 min-vh-100">
                <button class="btn btn-primary d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSidebar">
                    サイドバーを開く
                </button>
                <div class="offcanvas-lg offcanvas-start" tabindex="-1" id="offcanvasSidebar">
                    <div class="offcanvas-header">
                        <h5 class="offcanvas-title">サイドバー</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                    </div>
<!--                    <div class="offcanvas-body">-->
<!--                        <ul class="nav flex-column">-->
<!--                            <li class="nav-item">-->
<!--                                <a class="nav-link active" href="#">リンク1</a>-->
<!--                            </li>-->
<!--                            <li class="nav-item">-->
<!--                                <a class="nav-link" href="#">リンク2</a>-->
<!--                            </li>-->
<!--                            <li class="nav-item">-->
<!--                                <a class="nav-link" href="#">リンク3</a>-->
<!--                            </li>-->
<!--                        </ul>-->
<!--                    </div>-->
					<div id='calendar'></div>

					<script th:inline="javascript">
						/*<![CDATA[*/
						function formatDate(date) {
						    const year = date.getFullYear();
						    const month = String(date.getMonth() + 1).padStart(2, '0');
						    const day = String(date.getDate()).padStart(2, '0');
						    return `${year}-${month}-${day}`;
						}
						
					    document.addEventListener('DOMContentLoaded', function() {
							let isInitialLoad = true;
							const linksJson = /*[[${LinksJson}]]*/ null; // デフォルトをnullにしておく
							// linksJson が null でない場合のみ parse し、nullなら空のオブジェクト{}を割り当てる
							const articleLinks = linksJson ? JSON.parse(linksJson) : {};
					        var calendarEl = document.getElementById('calendar');
							//var initialDate = '[[${#temporals.format(today, \'yyyy-MM-dd\')}]]';
							const dateStringFromJava = /*[[${today.toString()}]]*/ null;
							var initialDate = new Date(dateStringFromJava);
							//alert("today=" + '[[${today.toString()}]]');
							//alert("initialDate=" + initialDate);
					        var calendar = new FullCalendar.Calendar(calendarEl, {
					            initialView: 'dayGridMonth',
					            // サーバーから渡された日付を初期表示月に設定
					            initialDate: initialDate,
					            // ... 他のオプション ...
								buttonText: {
								  today: '今月', // 'today' のテキストを「今日」に変更
								  prev: '前の月',
								  next: '次の月'
								},
								// 日本語化
								locale: 'ja',
								// デフォルトのナビゲーションリンクを無効化
								navLinks: false,
								// 日付セルのコンテンツをカスタマイズして枠線を追加
								dayCellContent: function(arg) {
									const dateStr = formatDate(arg.date);
									//alert("arg.date=" + arg.date);
									if (articleLinks[dateStr]) {
									    return {
									        html: `<a href="${articleLinks[dateStr]}" class="article-link" style="background-color: lightblue">${arg.date.getDate()}</a>`
									    };
									}
									return { html: arg.date.getDate() };
								},
								// 各日付セルがマウントされたときに実行される
								dayCellDidMount: function(arg) {
								  // 日付を 'YYYY-MM-DD' 形式で取得
								  const dateStr = formatDate(arg.date);
								  // 特定の日付リストに含まれているかチェック
								  if (articleLinks[dateStr]) {
								    // セルの背景色を変更
								    arg.el.style.backgroundColor = '#ADD8E6'; // lighitblue
								  }
								},
								datesSet: function(info) {
								  // 初回読み込み時はリダイレクトさせずに処理を終了
								  if (isInitialLoad) {
								    isInitialLoad = false; // 次回以降は実行されるようにフラグを倒す
								    return;
								  }
								  // 新しく表示された期間の開始日を取得
								  let startDate = new Date(info.start);
								  startDate.setDate(startDate.getDate() + 10);
								  console.log('startDate:', startDate);
								  // 年と月を取得 (JavaScriptの月は0から始まるため+1する)
								  const year = startDate.getFullYear();
								  const month = startDate.getMonth() + 1;
								  // 月をゼロ埋め2桁にフォーマット (例: 9月 -> '09')
								  const monthFormatted = String(month).padStart(2, '0');
								  // 目的のURLを組み立てる
								  const targetUrl = `/discard/search/${year}-${monthFormatted}`;
								  // (デバッグ用) コンソールにURLを出力して確認
								  console.log('Redirecting to:', targetUrl);
								  // 組み立てたURLへページを遷移させる
								  if (window.location.pathname !== targetUrl) {
								      window.location.href = targetUrl;
								  }
								}
							});
					        calendar.render();
					    });
						/*]]>*/
					</script>
					<form th:action="@{/discard/toSave}" method="get">
					    <button type="submit">記事登録</button>
					</form>
					<div th:if="${message}" class="alert alert-danger" role="alert">
					    <span th:text="${message}"></span>
					</div>
					<form th:action="@{/discard/logout}" method="post" class="pt-3">
						<input type="submit" value="ログアウト">
					</form>
                </div>
            </nav>

            <main class="content-wrapper col-lg-9 p-3 pt-5 pb-4 min-vh-100" style="background-color: #f0fff0;"　>
				<div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
				<div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>
				<div th:if="${articles}">
					<div th:each="article : ${articles}" class="article-container">
					    <div class="article-header">
					        <p class="article-date" th:text="${#temporals.format(article.date, 'yyyy年MM月dd日')}"></p>
					        <h2 class="article-title" th:text="${article.title}"></h2>
					    </div>
					    <div class="article-image">
				    	    <img th:src="@{/image/{filename}(filename=${article.imageFileName})}" alt="記事画像">
					    </div>
					    <div class="article-comments">
					        <span class="article-comment-tag" th:text="|種別：${article.trashType.name}|"></span>
					        <span class="article-comment-tag" th:text="|手間：${article.effort.name}|"></span>
							<span><a th:href="@{/discard/update/{date}(date=${#temporals.format(article.date,'yyyy-MM-dd')})}">記事更新</a></span>
							<span><a
								data-bs-toggle="modal"
								data-bs-target="#confirmModal"
								th:attr="data-url=@{/discard/delete/{date}(date=${#temporals.format(article.date,'yyyy-MM-dd')})}">記事削除</a></span>
					    </div>
					</div>
				</div>
				<div th:if="${articles.isEmpty()}">
					該当する記事がありません。
				<d/v>
           </main>

        </div>
    </div>

	<div th:replace="~{discard/fragments/footer :: footer}"></div>

	<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="confirmModalLabel">実行確認</h5>
	        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	      </div>
	      <div class="modal-body">
	        本当に操作を実行しますか？
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
	        <a id="confirmDeleteButton" class="btn btn-danger">実行</a>
	      </div>
	    </div>
	  </div>
	</div>	
	<script>
	    const confirmModal = document.getElementById('confirmModal');
	    // モーダルが表示される直前のイベントを捕捉
	    confirmModal.addEventListener('show.bs.modal', function (event) {
	        // イベントを引き起こした要素（クリックされた削除リンク）を取得
	        const button = event.relatedTarget;
	        // リンクからdata-url属性の値（削除用URL）を取得
	        const url = button.getAttribute('data-url');
	        // モーダル内の「削除」ボタンを取得
	        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
	        // 「削除」ボタンのhref属性にURLを設定
	        confirmDeleteButton.setAttribute('href', url);
	    });
	</script>	
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>